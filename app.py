import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
import time
from matplotlib.patches import Circle, Rectangle, Arc

# Configuraci√≥n de la p√°gina
st.set_page_config(page_title="Arn√©s Inteligente SST", page_icon="ü¶∫", layout="wide")

# T√≠tulo principal con dise√±o especial
st.markdown("""
<div style='text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; margin-bottom: 20px;'>
    <h1 style='color: white; margin: 0; font-size: 2.5em;'>ü¶∫ Sistema de Protecci√≥n Inteligente</h1>
    <h2 style='color: white; margin: 0; font-size: 1.8em;'>para Trabajos en Altura</h2>
</div>
""", unsafe_allow_html=True)

# Tarjeta con el nombre de la ingeniera
st.markdown("""
<div style='text-align: center; padding: 15px; background: #f0f8ff; border-radius: 10px; border-left: 5px solid #667eea; margin-bottom: 20px;'>
    <h3 style='color: #2c3e50; margin: 0; font-size: 1.3em;'>üë©‚Äçüî¨ Proyecto de Grado</h3>
    <h2 style='color: #8e44ad; margin: 0; font-size: 1.5em; font-weight: bold;'>Ingeniera en Seguridad y Salud en el Trabajo</h2>
    <h1 style='color: #2c3e50; margin: 0; font-size: 1.8em; font-weight: bold;'>üí´ Michell Andrea Rodriguez Rivera</h1>
</div>
""", unsafe_allow_html=True)

st.markdown("---")

# El resto del c√≥digo se mantiene igual...
# COLUMNA IZQUIERDA: Informaci√≥n educativa para SST
with st.sidebar:
    st.header("üìö Fundamentos del Proyecto")
    
    st.subheader("üéØ Objetivo del Sistema")
    st.info("""
    Proteger a trabajadores en altura mediante:
    - **Detecci√≥n temprana** de situaciones de riesgo
    - **Alertas inmediatas** para prevenci√≥n
    - **Monitoreo en tiempo real** de par√°metros cr√≠ticos
    """)
    
    st.subheader("‚ö° Par√°metros Monitoreados")
    
    with st.expander("üìä ACELERACI√ìN (Movimiento)"):
        st.write("""
        **Valores de referencia:**
        - üü¢ **9.8 m/s¬≤**: Gravedad normal (est√°tico)
        - üü° **5-9 m/s¬≤**: Movimientos bruscos
        - üî¥ **< 5 m/s¬≤**: ¬°POSIBLE CA√çDA LIBRE!
        - üî¥ **> 13 m/s¬≤**: Fuerzas peligrosas
        """)
    
    with st.expander("üìê √ÅNGULO (Postura)"):
        st.write("""
        **L√≠mites de seguridad:**
        - üü¢ **0¬∞-30¬∞**: Postura segura
        - üü° **30¬∞-60¬∞**: Precauci√≥n requerida
        - üî¥ **> 60¬∞**: ¬°PELIGRO DE VUELCO!
        """)

# FUNCI√ìN PARA DIBUJAR AL TRABAJADOR (se mantiene igual)
def dibujar_trabajador(angulo, estado, ax):
    # Limpiar el axes
    ax.clear()
    
    # Configurar el √°rea de dibujo
    ax.set_xlim(-2, 2)
    ax.set_ylim(-1, 3)
    ax.set_aspect('equal')
    
    # Color seg√∫n el estado
    if estado == "seguro":
        color_cuerpo = 'green'
        color_arnes = 'darkgreen'
    elif estado == "precaucion":
        color_cuerpo = 'orange'
        color_arnes = 'darkorange'
    else:  # peligro
        color_cuerpo = 'red'
        color_arnes = 'darkred'
    
    # Convertir √°ngulo a radianes para la rotaci√≥n
    angulo_rad = np.radians(angulo)
    
    # Dibujar cuerpo (rect√°ngulo rotado)
    cuerpo = Rectangle((-0.3, -0.5), 0.6, 1.5, color=color_cuerpo, alpha=0.7)
    
    # Aplicar rotaci√≥n al cuerpo
    transform = plt.matplotlib.transforms.Affine2D().rotate_around(0, 0, angulo_rad) + ax.transData
    cuerpo.set_transform(transform)
    ax.add_patch(cuerpo)
    
    # Dibujar cabeza (c√≠rculo)
    cabeza = Circle((0, 1.2), 0.2, color=color_cuerpo, alpha=0.7)
    cabeza.set_transform(transform)
    ax.add_patch(cabeza)
    
    # Dibujar arn√©s (en forma de H)
    # Tirantes verticales
    tirante_izq = Rectangle((-0.25, 0.2), 0.1, 0.8, color=color_arnes, alpha=0.9)
    tirante_der = Rectangle((0.15, 0.2), 0.1, 0.8, color=color_arnes, alpha=0.9)
    # Tirante horizontal
    tirante_horizontal = Rectangle((-0.25, 0.8), 0.5, 0.1, color=color_arnes, alpha=0.9)
    
    for tirante in [tirante_izq, tirante_der, tirante_horizontal]:
        tirante.set_transform(transform)
        ax.add_patch(tirante)
    
    # Dibujar l√≠nea de seguridad (cuerda)
    if estado == "peligro":
        # L√≠nea rota en caso de peligro
        ax.plot([0, 0.5], [2.5, 2.0], 'r--', linewidth=3, alpha=0.7)
        ax.plot([0.5, 1.0], [2.0, 1.5], 'r--', linewidth=3, alpha=0.7)
    else:
        # L√≠nea s√≥lida en caso seguro
        ax.plot([0, 0], [2.5, 1.5], 'gray', linewidth=3, alpha=0.7)
    
    # A√±adir texto del estado
    ax.text(0, -0.8, f'√Ångulo: {angulo}¬∞', ha='center', fontsize=12, fontweight='bold',
            color=color_cuerpo, bbox=dict(boxstyle="round,pad=0.3", facecolor='white', alpha=0.8))
    
    # Quitar ejes
    ax.set_xticks([])
    ax.set_yticks([])
    ax.spines['top'].set_visible(False)
    ax.spines['right'].set_visible(False)
    ax.spines['bottom'].set_visible(False)
    ax.spines['left'].set_visible(False)
    
    # T√≠tulo del gr√°fico
    ax.set_title('üë∑ SIMULACI√ìN DEL TRABAJADOR', fontsize=14, fontweight='bold', pad=20)

# CONTROLES PRINCIPALES
st.header("üéÆ Simulador de Situaciones de Riesgo")

col1, col2, col3 = st.columns([2, 1, 1])

with col1:
    modo = st.selectbox(
        "**Selecciona el escenario a simular:**",
        [
            "TRABAJO NORMAL - Situaci√≥n segura",
            "CA√çDA LIBRE - Emergencia m√°xima", 
            "POSTURA PELIGROSA - Riesgo de vuelco",
            "SOBRECARGA - Fuerzas excesivas"
        ],
        help="Elige diferentes situaciones que pueden ocurrir en trabajos en altura"
    )

with col2:
    duracion = st.slider("**Duraci√≥n (segundos):**", 5, 30, 15)

with col3:
    st.write("**Control de simulaci√≥n:**")
    start_col, stop_col = st.columns(2)
    with start_col:
        start = st.button("‚ñ∂Ô∏è INICIAR", type="primary", use_container_width=True)
    with stop_col:
        stop = st.button("‚èπÔ∏è DETENER", use_container_width=True)

# PANEL DE ESTADO PRINCIPAL
st.header("üìä Panel de Monitoreo en Tiempo Real")

# Crear columnas para los datos
col_status, col_visual, col_metrics = st.columns([2, 2, 1])

with col_status:
    status_display = st.empty()
    situation_explanation = st.empty()

with col_visual:
    st.subheader("üë∑ Simulaci√≥n Visual")
    worker_placeholder = st.empty()

with col_metrics:
    st.subheader("üìà M√©tricas")
    accel_display = st.empty()
    angle_display = st.empty()
    incidents_display = st.metric(
        "üö® Incidentes Detectados", 
        st.session_state.get('fall_count', 0)
    )

# √Årea de gr√°ficos
st.subheader("üìà Gr√°ficos de Monitoreo T√©cnico")
graph_placeholder = st.empty()
progress_bar = st.empty()

# Inicializar variables
if "fall_count" not in st.session_state:
    st.session_state.fall_count = 0
if "simulation_running" not in st.session_state:
    st.session_state.simulation_running = False

# L√≥gica de simulaci√≥n
if stop:
    st.session_state.simulation_running = False

if start and not st.session_state.simulation_running:
    st.session_state.simulation_running = True
    
    fs = 10  # Muestras por segundo
    t_vals, accel_vals, angle_vals = [], [], []
    
    progress_bar = st.progress(0)
    
    for i in range(duracion * fs):
        if not st.session_state.simulation_running:
            break
            
        t = i / fs
        progress = (i + 1) / (duracion * fs)
        progress_bar.progress(progress)
        
        # --- GENERAR DATOS SEG√öN ESCENARIO ---
        if "TRABAJO NORMAL" in modo:
            accel = 9.8 + 0.2 * np.random.randn()
            angle = 10 + np.sin(0.5 * t) * 5
            status = "üü¢ SITUACI√ìN NORMAL"
            status_color = "success"
            explanation = "El trabajador realiza sus labores de forma segura"
            estado_visual = "seguro"
            
        elif "CA√çDA LIBRE" in modo:
            if t < duracion / 2:
                accel = 9.8 + 0.2 * np.random.randn()
                angle = 15 + 5 * np.random.randn()
                status = "üü¢ SITUACI√ìN NORMAL"
                status_color = "success"
                explanation = "Trabajador realizando labores normales"
                estado_visual = "seguro"
            else:
                accel = 2 + 0.3 * np.random.randn()
                angle = 70 + 10 * np.random.randn()
                status = "üî¥ ¬°CA√çDA DETECTADA!"
                status_color = "error"
                explanation = "¬°EMERGENCIA! Aceleraci√≥n por debajo de 5 m/s¬≤ indica ca√≠da libre"
                estado_visual = "peligro"
                
        elif "POSTURA PELIGROSA" in modo:
            accel = 9.8 + 0.2 * np.random.randn()
            if t < duracion / 2:
                angle = 15 + 5 * np.random.randn()
                status = "üü¢ SITUACI√ìN NORMAL"
                status_color = "success"
                explanation = "Postura dentro de l√≠mites seguros"
                estado_visual = "seguro"
            else:
                angle = 75 + 5 * np.random.randn()
                status = "üü° POSTURA PELIGROSA"
                status_color = "warning"
                explanation = "¬°√Ångulo superior a 60¬∞! Riesgo de vuelco"
                estado_visual = "peligro"
                
        else:  # SOBRECARGA
            if t < duracion / 2:
                accel = 9.8 + 0.2 * np.random.randn()
                status = "üü¢ SITUACI√ìN NORMAL"
                status_color = "success"
                explanation = "Fuerzas dentro de par√°metros normales"
                estado_visual = "seguro"
            else:
                accel = 14 + 0.5 * np.random.randn()
                status = "üü° SOBRECARGA DETECTADA"
                status_color = "warning"
                explanation = "¬°Fuerzas excesivas! Puede da√±ar el arn√©s"
                estado_visual = "precaucion"
            angle = 20 + np.sin(0.5 * t) * 5
        
        # --- DETECCI√ìN DE INCIDENTES ---
        incidente = (accel < 5) or (angle > 60) or (accel > 13)
        
        if incidente:
            st.session_state.fall_count += 1
            
            # Mostrar protocolo de emergencia
            st.error(f"""
            üö® **PROTOCOLO DE EMERGENCIA ACTIVADO**
            
            **Situaci√≥n:** {modo.split(' - ')[0]}
            **Tiempo del incidente:** {t:.1f} segundos
            **Acciones autom√°ticas:**
            ‚Ä¢ üîä Alarma sonora activada
            ‚Ä¢ üì± Alertas enviadas a supervisores  
            ‚Ä¢ üìç GPS compartido con rescate
            ‚Ä¢ üè• Servicios m√©dicos notificados
            """)
            
            # Efectos visuales para emergencia
            st.balloons()
            
        else:
            st.success("""
            ‚úÖ **SISTEMA EN ESTADO NORMAL**
            
            **Monitoreo activo:**
            ‚Ä¢ üìä Par√°metros dentro de l√≠mites
            ‚Ä¢ üë∑ Trabajador en situaci√≥n segura
            ‚Ä¢ üîÑ Monitoreo continuo
            """)
        
        # Actualizar displays
        if status_color == "success":
            status_display.success(f"**{status}**")
        elif status_color == "warning":
            status_display.warning(f"**{status}**")
        else:
            status_display.error(f"**{status}**")
            
        situation_explanation.info(f"**Explicaci√≥n:** {explanation}")
        
        accel_display.metric("Aceleraci√≥n", f"{accel:.1f} m/s¬≤")
        angle_display.metric("√Ångulo", f"{angle:.1f}¬∞")
        
        # --- DIBUJAR TRABAJADOR ---
        fig_worker, ax_worker = plt.subplots(figsize=(4, 6))
        dibujar_trabajador(int(angle), estado_visual, ax_worker)
        worker_placeholder.pyplot(fig_worker)
        plt.close(fig_worker)
        
        # Guardar datos para gr√°fico t√©cnico
        t_vals.append(t)
        accel_vals.append(accel)
        angle_vals.append(angle)
        
        # --- CREAR GR√ÅFICOS T√âCNICOS ---
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 6))
        
        # Gr√°fico de aceleraci√≥n
        ax1.plot(t_vals, accel_vals, 'b-', linewidth=2, label='ACELERACI√ìN')
        ax1.axhline(y=9.8, color='green', linestyle='-', alpha=0.6, label='GRAVEDAD NORMAL')
        ax1.axhline(y=5, color='red', linestyle='--', alpha=0.7, label='L√çMITE CA√çDA')
        ax1.axhline(y=13, color='orange', linestyle='--', alpha=0.7, label='L√çMITE SOBRECARGA')
        ax1.set_ylabel('Aceleraci√≥n (m/s¬≤)')
        ax1.legend()
        ax1.grid(True, alpha=0.3)
        
        # Gr√°fico de √°ngulo
        ax2.plot(t_vals, angle_vals, 'g-', linewidth=2, label='√ÅNGULO')
        ax2.axhline(y=60, color='red', linestyle='--', alpha=0.7, label='L√çMITE PELIGROSO')
        ax2.set_ylabel('√Ångulo (¬∞)')
        ax2.set_xlabel('Tiempo (segundos)')
        ax2.legend()
        ax2.grid(True, alpha=0.3)
        
        plt.tight_layout()
        graph_placeholder.pyplot(fig)
        plt.close(fig)
        
        time.sleep(1/fs)
    
    # Finalizar simulaci√≥n
    progress_bar.empty()
    st.session_state.simulation_running = False
    st.success("üéâ **Simulaci√≥n completada exitosamente**")

# INFORMACI√ìN EDUCATIVA
st.markdown("---")
st.header("üéì Material de Apoyo para la Exposici√≥n")

col_exp1, col_exp2 = st.columns(2)

with col_exp1:
    st.subheader("üí° Puntos Clave para la Exposici√≥n")
    st.info("""
    **Visualizaci√≥n del sistema:**
    - üë∑ **Verde**: Situaci√≥n normal y segura
    - üü† **Naranja**: Precauci√≥n - par√°metros cercanos a l√≠mites
    - üî¥ **Rojo**: Peligro - activaci√≥n de protocolos de emergencia
    
    **La simulaci√≥n muestra:**
    - Postura real del trabajador
    - Estado del arn√©s de seguridad
    - L√≠nea de vida y anclajes
    """)

# CONCLUSI√ìN
st.success("""
**üéØ Mensaje Final:**
*"Combinamos tecnolog√≠a moderna con principios de SST para crear protecci√≥n visual e intuitiva que todos pueden entender."*
""")

# Cr√©ditos finales
st.markdown("---")
st.markdown("""
<div style='text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;'>
    <h3 style='color: #6c757d;'>Desarrollado para el Proyecto de Grado de</h3>
    <h2 style='color: #495057; font-weight: bold;'>Ing. Michell Andrea Rodriguez Rivera</h2>
    <p style='color: #6c757d;'>Ingeniera en Seguridad y Salud en el Trabajo</p>
</div>
""", unsafe_allow_html=True)
